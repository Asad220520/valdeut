<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–ù–µ–º–µ—Ü–∫–∏–π –ø–æ –ª–µ–∫—Ü–∏—è–º (–†—É—Å ‚Üí –ù–µ–º)</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background: #f7f7f7;
      }
      header {
        background: #4caf50;
        color: white;
        padding: 1rem;
        text-align: center;
      }
      nav {
        display: flex;
        overflow-x: auto;
        background: #333;
      }
      nav button {
        padding: 0.8rem 1rem;
        margin: 2px;
        color: white;
        background: #333;
        border: none;
        cursor: pointer;
        flex: 0 0 auto;
        min-width: 100px;
        white-space: nowrap;
      }
      nav button.active {
        background: #4caf50;
      }
      main {
        padding: 1rem;
        max-width: 600px;
        margin: auto;
      }
      #lecture-info {
        margin-bottom: 1rem;
        font-weight: bold;
      }
      .search-bar {
        margin-bottom: 1rem;
      }
      .search-bar input {
        width: 100%;
        padding: 0.5rem;
        font-size: 1rem;
        border-radius: 5px;
        border: 1px solid #ccc;
      }
      .category {
        margin-bottom: 2rem;
      }
      .category h2 {
        margin: 0 0 0.5rem 0;
        font-size: 1.1rem;
      }
      .word {
        background: white;
        margin-bottom: 1rem;
        padding: 1rem;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        transition: background 0.3s, transform 0.2s;
        display: flex;
        flex-direction: column;
        cursor: pointer;
      }
      .word.learned {
        background: #d3ffd3;
        transform: scale(1.02);
      }
      .word h3 {
        margin: 0 0 0.5rem 0;
        font-size: 1rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .examples p {
        margin: 0.3rem 0;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .select-word {
        margin-right: 0.5rem;
      }
      .mark-learned-btn {
        background: #4caf50;
        color: white;
        border: none;
        border-radius: 5px;
        padding: 0.3rem 0.5rem;
        cursor: pointer;
        font-size: 0.8rem;
        margin-left: 0.5rem;
      }
      .speak-word-btn {
        background: #fff;
        border: 1px solid #4caf50;
        border-radius: 5px;
        padding: 0.2rem 0.4rem;
        margin-left: 5px;
        cursor: pointer;
        color: #4caf50;
      }
      #study-bar {
        position: fixed;
        bottom: 0;
        width: 100%;
        background: #4caf50;
        color: white;
        padding: 0.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 1000;
        flex-wrap: wrap;
      }
      #study-bar button {
        background: white;
        color: #4caf50;
        border-radius: 5px;
        padding: 0.5rem 0.8rem;
        font-weight: bold;
        margin: 3px;
        font-size: 1rem;
      }
      #mode-select {
        margin-right: 1rem;
      }
      #study-mode {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.95);
        z-index: 1001;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 1rem;
        animation: fadeIn 0.3s ease;
      }
      .study-card {
        background: #fff;
        border-radius: 15px;
        padding: 2rem;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        text-align: center;
      }
      #progress {
        font-size: 0.9rem;
        color: #555;
        margin-bottom: 1rem;
      }
      #study-word {
        font-size: 1.8rem;
        font-weight: bold;
        margin-bottom: 1rem;
        color: #4caf50;
      }
      #study-input {
        width: 100%;
        padding: 0.7rem;
        font-size: 1.2rem;
        border-radius: 8px;
        border: 1px solid #ccc;
        margin-bottom: 0.5rem;
      }
      .buttons-row button {
        padding: 0.5rem 1rem;
        font-size: 1rem;
        margin: 0.3rem;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        transition: transform 0.1s;
      }
      .buttons-row button:hover {
        transform: scale(1.05);
      }
      #check-result {
        font-weight: bold;
        margin-top: 0.5rem;
        min-height: 1.2em;
      }
      #study-translation {
        font-style: italic;
        color: #555;
        margin-top: 0.5rem;
        display: none;
      }
      .exit-btn {
        margin-top: 1rem;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        background: #999;
        color: white;
        border: none;
        cursor: pointer;
      }
      .exit-btn:hover {
        background: #666;
      }
      .hint {
        margin: 0.5rem 0;
        font-size: 0.9rem;
        color: #555;
        text-align: left;
      }
      .hint span {
        display: inline-block;
        background: #eee;
        padding: 0.2rem 0.4rem;
        margin-right: 0.3rem;
        border-radius: 3px;
        cursor: pointer;
      }
      .select-all-btns {
        margin-bottom: 0.5rem;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
      @media (max-width: 480px) {
        nav button {
          font-size: 0.7rem;
          padding: 0.5rem;
          min-width: 80px;
        }
        #study-word {
          font-size: 1.5rem;
        }
        #study-input {
          width: 80%;
        }
        #study-bar {
          flex-direction: column;
          align-items: flex-start;
        }
        #study-bar button {
          width: 100%;
          font-size: 1.1rem;
        }
      }
      #night-mode {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #111;
        color: #fff;
        z-index: 2000;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 1rem;
        text-align: center;
      }
      #night-word {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
        color: #4caf50;
      }
      #night-translation {
        font-size: 1.5rem;
        margin-bottom: 1rem;
        color: #ccc;
      }
      #night-mode button {
        padding: 1rem 2rem;
        font-size: 1.2rem;
        border: none;
        border-radius: 10px;
        cursor: pointer;
      }
      #stop-night {
        background: #e53935;
        color: white;
        margin-top: 1rem;
      }
      #interval-range {
        width: 200px;
      }
    </style>
  </head>
  <body>
    <header><h1>–ù–µ–º–µ—Ü–∫–∏–π –ø–æ –ª–µ–∫—Ü–∏—è–º (–†—É—Å ‚Üí –ù–µ–º)</h1></header>
    <nav></nav>
    <main id="content">
      <div id="lecture-info"></div>
      <div class="search-bar">
        <input type="text" id="search-input" placeholder="–ü–æ–∏—Å–∫ —Å–ª–æ–≤–∞..." />
      </div>
    </main>

    <div id="study-bar">
      <span id="selected-count">–í—ã–±—Ä–∞–Ω–æ —Å–ª–æ–≤: 0</span>
      <div id="mode-select">
        <label
          ><input type="radio" name="study-type" value="words" checked /> –¢–æ–ª—å–∫–æ
          —Å–ª–æ–≤–∞</label
        >
        <label
          ><input type="radio" name="study-type" value="sentences" />
          –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è</label
        >
      </div>
      <div>
        <button id="start-study">–ù–∞—á–∞—Ç—å –∏–∑—É—á–µ–Ω–∏–µ</button>
        <button id="start-night">üåô –ù–æ—á–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ</button>
      </div>
    </div>

    <div id="study-mode">
      <div class="study-card">
        <div id="progress">–°–ª–æ–≤–æ 1 –∏–∑ 1</div>
        <div id="writing-step">
          <div id="study-word"></div>
          <input
            type="text"
            id="study-input"
            placeholder="–ù–∞–ø–∏—à–∏ –Ω–µ–º–µ—Ü–∫–æ–µ —Å–ª–æ–≤–æ –∏–ª–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ"
          />
          <div class="hint">
            –í—Å—Ç–∞–≤—å—Ç–µ –Ω–µ–º–µ—Ü–∫–∏–µ –±—É–∫–≤—ã:
            <span onclick="Study.insertChar('√§')">√§</span>
            <span onclick="Study.insertChar('√∂')">√∂</span>
            <span onclick="Study.insertChar('√º')">√º</span>
            <span onclick="Study.insertChar('√ü')">√ü</span>
          </div>
          <div class="buttons-row">
            <button id="check-btn">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
            <button id="show-translation">–ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–≤–µ—Ç</button>
            <button id="speak-btn">üîä</button>
          </div>
          <div id="check-result"></div>
          <div id="study-translation"></div>
          <button id="next-btn" style="display: none; margin-top: 10px">
            –î–∞–ª–µ–µ
          </button>
        </div>
        <button id="exit-study" class="exit-btn">–í—ã–π—Ç–∏</button>
      </div>
    </div>

    <div id="night-mode">
      <h2>üåô –ù–æ—á–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ</h2>
      <div id="night-word"></div>
      <div id="night-translation"></div>
      <label
        >‚è± –ò–Ω—Ç–µ—Ä–≤–∞–ª: <span id="interval-label">3</span> —Å–µ–∫
        <input type="range" id="interval-range" min="1" max="10" value="3" />
      </label>
      <button id="stop-night">‚èπ –í—ã–π—Ç–∏</button>
    </div>

    <script>
      let lectures = {};
      let learned = JSON.parse(localStorage.getItem("learnedWords")) || [];
      let studyList = [];
      let currentUtterance = null;

      const content = document.getElementById("content");
      const nav = document.querySelector("nav");
      const selectedCount = document.getElementById("selected-count");
      const startStudyBtn = document.getElementById("start-study");
      const studyMode = document.getElementById("study-mode");
      const studyWordEl = document.getElementById("study-word");
      const studyInput = document.getElementById("study-input");
      const checkBtn = document.getElementById("check-btn");
      const checkResult = document.getElementById("check-result");
      const studyTranslationEl = document.getElementById("study-translation");
      const showTranslationBtn = document.getElementById("show-translation");
      const exitStudyBtn = document.getElementById("exit-study");
      const progressEl = document.getElementById("progress");
      const nextBtn = document.getElementById("next-btn");
      const speakBtn = document.getElementById("speak-btn");

      // üåô Night mode elements
      const nightMode = document.getElementById("night-mode");
      const nightWordEl = document.getElementById("night-word");
      const nightTranslationEl = document.getElementById("night-translation");
      const nightBtn = document.getElementById("start-night");
      const stopNightBtn = document.getElementById("stop-night");
      const intervalRange = document.getElementById("interval-range");
      const intervalLabel = document.getElementById("interval-label");
      let nightIndex = 0;
      let nightTimer = null;
      let nightInterval = 3000;

      // ----------------- –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ–∑–≤—É—á–∫–∏ -----------------
      function speak(text, preferredLang = null) {
        if (!text) return;
        if (currentUtterance) {
          speechSynthesis.cancel();
          currentUtterance = null;
        }

        const isCyrillic = /[–ê-–Ø–∞-—è–Å—ë]/.test(text);
        const lang = preferredLang || (isCyrillic ? "ru-RU" : "de-DE");

        const utter = new SpeechSynthesisUtterance(text);
        utter.lang = lang;

        function setVoiceAndSpeak() {
          const voices = speechSynthesis.getVoices();
          if (!voices.length) return;

          let voice = voices.find((v) =>
            v.lang.toLowerCase().startsWith(lang.toLowerCase())
          );
          if (!voice) {
            const shortLang = lang.split("-")[0];
            voice = voices.find((v) =>
              v.lang.toLowerCase().startsWith(shortLang)
            );
          }

          if (voice) utter.voice = voice;
          utter.rate = 0.95;
          utter.pitch = 1;

          currentUtterance = utter;
          utter.onend = () => {
            currentUtterance = null;
          };
          speechSynthesis.speak(utter);
        }

        if (!speechSynthesis.getVoices().length) {
          speechSynthesis.onvoiceschanged = setVoiceAndSpeak;
        } else {
          setVoiceAndSpeak();
        }
      }

      // ----------------- –ù–æ—á–Ω–æ–π —Ä–µ–∂–∏–º -----------------
      function startNightMode() {
        if (!studyList.length) return alert("–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ —Å–ª–æ–≤–æ");
        nightIndex = 0;
        nightMode.style.display = "flex";
        playNightStep();
      }
      function stopNightMode() {
        clearTimeout(nightTimer);
        speechSynthesis.cancel();
        nightMode.style.display = "none";
      }
      function playNightStep() {
        if (nightIndex >= studyList.length) nightIndex = 0;
        const w = studyList[nightIndex];

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∂–∏–º: —Å–ª–æ–≤–∞ –∏–ª–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
        const mode = document.querySelector(
          'input[name="study-type"]:checked'
        ).value;

        if (mode === "sentences" && w.examples && w.examples.length > 0) {
          // –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–π –ø—Ä–∏–º–µ—Ä
          const ex = w.examples[Math.floor(Math.random() * w.examples.length)];
          nightWordEl.textContent = ex.ru; // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä—É—Å—Å–∫–∏–π —Ç–µ–∫—Å—Ç
          nightTranslationEl.textContent = "";

          speak(ex.ru); // –æ–∑–≤—É—á–∏–≤–∞–µ–º —Ä—É—Å—Å–∫–∏–π —Ç–µ–∫—Å—Ç

          nightTimer = setTimeout(() => {
            nightTranslationEl.textContent = ex.de; // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–µ–º–µ—Ü–∫–∏–π –ø–µ—Ä–µ–≤–æ–¥
            speak(ex.de); // –æ–∑–≤—É—á–∏–≤–∞–µ–º –Ω–µ–º–µ—Ü–∫–∏–π —Ç–µ–∫—Å—Ç

            nightTimer = setTimeout(() => {
              nightIndex++;
              playNightStep();
            }, nightInterval);
          }, nightInterval);
        } else {
          // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ä–µ–∂–∏–º "—Ç–æ–ª—å–∫–æ —Å–ª–æ–≤–∞"
          nightWordEl.textContent = w.word;
          nightTranslationEl.textContent = "";

          speak(w.word);

          nightTimer = setTimeout(() => {
            nightTranslationEl.textContent = w.translation;
            speak(w.translation);

            nightTimer = setTimeout(() => {
              nightIndex++;
              playNightStep();
            }, nightInterval);
          }, nightInterval);
        }
      }

      intervalRange.addEventListener("input", () => {
        nightInterval = intervalRange.value * 1000;
        intervalLabel.textContent = intervalRange.value;
      });
      nightBtn.addEventListener("click", startNightMode);
      stopNightBtn.addEventListener("click", stopNightMode);

      // ----------------- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ª–µ–∫—Ü–∏–π -----------------
      fetch("./lectures.json")
        .then((res) => res.json())
        .then((data) => {
          lectures = data;
          initApp();
        })
        .catch((err) => {
          content.innerHTML = "<p>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ª–µ–∫—Ü–∏–∏.</p>";
          console.error(err);
        });

      function initApp() {
        Object.keys(lectures).forEach((lecNum, idx) => {
          const btn = document.createElement("button");
          btn.textContent = `–õ–µ–∫—Ü–∏—è ${lecNum}`;
          btn.dataset.lecture = lecNum;
          btn.classList.add("tab-btn");
          btn.addEventListener("click", () => {
            document
              .querySelectorAll(".tab-btn")
              .forEach((t) => t.classList.remove("active"));
            btn.classList.add("active");
            showLecture(lecNum);
          });
          nav.appendChild(btn);
          if (idx === 0) {
            btn.classList.add("active");
            showLecture(lecNum);
          }
        });
      }

      function capitalize(str) {
        return str.charAt(0).toUpperCase() + str.slice(1);
      }
      function getLearnedCount(lectureNum, category) {
        const words = lectures[lectureNum][category] || [];
        return words.filter((_, i) =>
          learned.includes(`${lectureNum}-${category}-${i}`)
        ).length;
      }

      // ----------------- –ü–æ–∫–∞–∑ –ª–µ–∫—Ü–∏–∏ -----------------
      function showLecture(lectureNumber) {
        content.innerHTML =
          '<div id="lecture-info"></div><div class="search-bar"><input type="text" id="search-input" placeholder="–ü–æ–∏—Å–∫ —Å–ª–æ–≤–∞..."></div>';
        studyList = [];
        updateSelectedCount();
        let totalWords = 0;
        let totalLearned = 0;
        let globalIndex = 1;

        const lecture = lectures[lectureNumber];
        Object.keys(lecture).forEach((cat) => {
          const words = lecture[cat];
          if (!words || !words.length) return;

          const catDiv = document.createElement("div");
          catDiv.classList.add("category");

          const countLearned = getLearnedCount(lectureNumber, cat);
          totalWords += words.length;
          totalLearned += countLearned;

          catDiv.innerHTML += `<h2>${capitalize(cat)} (${
            words.length
          } —Å–ª–æ–≤) - –≤—ã—É—á–µ–Ω–æ ${countLearned}/${words.length}</h2>`;

          const selectAllDiv = document.createElement("div");
          selectAllDiv.classList.add("select-all-btns");
          const selectAllBtn = document.createElement("button");
          selectAllBtn.textContent = "–í—ã–±—Ä–∞—Ç—å –≤—Å–µ";
          selectAllBtn.style.marginRight = "5px";
          selectAllBtn.addEventListener("click", () => {
            catDiv.querySelectorAll(".select-word").forEach((cb) => {
              if (!cb.checked) {
                cb.checked = true;
                toggleSelectWord({ target: cb });
              }
            });
          });
          const deselectAllBtn = document.createElement("button");
          deselectAllBtn.textContent = "–°–Ω—è—Ç—å –≤—Å–µ";
          deselectAllBtn.addEventListener("click", () => {
            catDiv.querySelectorAll(".select-word").forEach((cb) => {
              if (cb.checked) {
                cb.checked = false;
                toggleSelectWord({ target: cb });
              }
            });
          });
          selectAllDiv.appendChild(selectAllBtn);
          selectAllDiv.appendChild(deselectAllBtn);
          catDiv.appendChild(selectAllDiv);

          words.forEach((item, index) => {
            const id = `${lectureNumber}-${cat}-${index}`;
            const div = document.createElement("div");
            div.classList.add("word");
            if (learned.includes(id)) div.classList.add("learned");
            div.dataset.wordText = item.word;

            div.innerHTML = `
              <h3>
                <div>
                  ${globalIndex++}.
                  <input type="checkbox" class="select-word" data-id="${id}" data-word='${JSON.stringify(
              item
            )}'>
                  ${item.word}
                  <button class="speak-word-btn" title="–ü—Ä–æ—Å–ª—É—à–∞—Ç—å">üîä</button>
                  <span class="word-translation">${item.translation}</span>
                </div>
                <button class="mark-learned-btn">${
                  learned.includes(id) ? "‚ùå –°–Ω—è—Ç—å –æ—Ç–º–µ—Ç–∫—É" : "‚úÖ –í—ã—É—á–∏–ª"
                }</button>
              </h3>
              <div class="examples">
                ${item.examples
                  .map(
                    (ex) =>
                      `<p>${ex.ru} ‚Üí <span class="translation">${ex.de}</span> <button class="speak-word-btn" title="–ü—Ä–æ—Å–ª—É—à–∞—Ç—å –ø—Ä–∏–º–µ—Ä">üîä</button></p>`
                  )
                  .join("")}
              </div>
            `;

            div
              .querySelector(".mark-learned-btn")
              .addEventListener("click", (e) => {
                e.stopPropagation();
                toggleLearned(id, div);
              });
            div
              .querySelector(".select-word")
              .addEventListener("change", (e) => toggleSelectWord(e));
            div.querySelectorAll(".speak-word-btn").forEach((btn) =>
              btn.addEventListener("click", (e) => {
                e.stopPropagation();
                const p = btn.closest("p");
                let text = p
                  ? p.querySelector(".translation")?.textContent ||
                    p.textContent.replace(/‚Üí/g, "").trim()
                  : item.word;
                speak(text);
              })
            );

            catDiv.appendChild(div);
          });

          content.appendChild(catDiv);
        });

        document.getElementById(
          "lecture-info"
        ).textContent = `–í—Å–µ–≥–æ —Å–ª–æ–≤: ${totalWords}, –≤—ã—É—á–µ–Ω–æ: ${totalLearned}`;
        document
          .getElementById("search-input")
          .addEventListener("input", filterWords);
      }

      function toggleLearned(id, div) {
        const index = learned.indexOf(id);
        if (index === -1) {
          learned.push(id);
          div.classList.add("learned");
          div.querySelector(".mark-learned-btn").textContent =
            "‚ùå –°–Ω—è—Ç—å –æ—Ç–º–µ—Ç–∫—É";
        } else {
          learned.splice(index, 1);
          div.classList.remove("learned");
          div.querySelector(".mark-learned-btn").textContent = "‚úÖ –í—ã—É—á–∏–ª";
        }
        localStorage.setItem("learnedWords", JSON.stringify(learned));
      }

      function filterWords() {
        const query = document
          .getElementById("search-input")
          .value.toLowerCase();
        document
          .querySelectorAll(".word")
          .forEach(
            (w) =>
              (w.style.display = w.dataset.wordText
                .toLowerCase()
                .includes(query)
                ? "flex"
                : "none")
          );
      }

      function toggleSelectWord(e) {
        const checkbox = e.target;
        const id = checkbox.dataset.id;
        const wordData = JSON.parse(checkbox.dataset.word);
        if (checkbox.checked) {
          studyList.push({
            id,
            word: wordData.word,
            translation: wordData.translation,
            examples: wordData.examples || [],
          });
        } else {
          studyList = studyList.filter((w) => w.id !== id);
        }
        updateSelectedCount();
      }

      function updateSelectedCount() {
        selectedCount.textContent = `–í—ã–±—Ä–∞–Ω–æ —Å–ª–æ–≤: ${studyList.length}`;
      }

      // ----------------- –ú–æ–¥—É–ª—å Study -----------------
      const Study = {
        list: [],
        index: 0,
        mode: "words",
        init(list) {
          if (!list.length) return alert("–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ —Å–ª–æ–≤–æ");
          this.list = list;
          this.index = 0;
          this.mode = document.querySelector(
            'input[name="study-type"]:checked'
          ).value;
          this.showStep();
          studyMode.style.display = "flex";
        },
        current() {
          return this.list[this.index];
        },
        showStep() {
          if (this.index >= this.list.length) return this.end();
          const w = this.current();
          if (
            this.mode === "sentences" &&
            w.examples &&
            w.examples.length > 0
          ) {
            const ex =
              w.examples[Math.floor(Math.random() * w.examples.length)];
            studyWordEl.textContent = ex.ru;
            studyTranslationEl.textContent = ex.de;
          } else {
            studyWordEl.textContent = w.translation;
            studyTranslationEl.textContent = w.word;
          }
          studyInput.value = "";
          checkResult.textContent = "";
          studyTranslationEl.style.display = "none";
          nextBtn.style.display = "none";
          progressEl.textContent = `–°–ª–æ–≤–æ ${this.index + 1} –∏–∑ ${
            this.list.length
          }`;
          studyInput.focus();
        },
        normalize(str) {
          return str
            .toLowerCase()
            .replace(/[.,!?;:]/g, "")
            .trim();
        },
        checkAnswer() {
          const input = studyInput.value.trim();
          const correct = studyTranslationEl.textContent;
          const correctWords = correct.split(/\s+/).map(this.normalize);
          const userWords = input.split(/\s+/).map(this.normalize);
          const isCorrect = correctWords.every((word) =>
            userWords.includes(word)
          );
          checkResult.textContent = isCorrect ? "–í–µ—Ä–Ω–æ!" : "–ù–µ–≤–µ—Ä–Ω–æ";
          checkResult.style.color = isCorrect ? "green" : "red";
          studyTranslationEl.style.display = "block";
          nextBtn.style.display = "inline-block";
          if (isCorrect) {
            this.markAsLearned(this.current().id);
            speak(correct);
          }
        },
        next() {
          this.index++;
          this.showStep();
        },
        end() {
          alert("–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!");
          studyMode.style.display = "none";
          this.list = [];
          this.index = 0;
          updateSelectedCount();
          document
            .querySelectorAll(".select-word")
            .forEach((cb) => (cb.checked = false));
        },
        markAsLearned(id) {
          if (!learned.includes(id)) {
            learned.push(id);
            localStorage.setItem("learnedWords", JSON.stringify(learned));
            document
              .querySelectorAll(`.select-word[data-id="${id}"]`)
              .forEach((cb) => {
                cb.checked = false;
                cb.closest(".word").classList.add("learned");
                cb
                  .closest(".word")
                  .querySelector(".mark-learned-btn").textContent =
                  "‚ùå –°–Ω—è—Ç—å –æ—Ç–º–µ—Ç–∫—É";
              });
          }
        },
        insertChar(char) {
          const start = studyInput.selectionStart;
          const end = studyInput.selectionEnd;
          const text = studyInput.value;
          studyInput.value = text.slice(0, start) + char + text.slice(end);
          studyInput.focus();
          studyInput.setSelectionRange(start + 1, start + 1);
        },
      };

      startStudyBtn.addEventListener("click", () => Study.init(studyList));
      checkBtn.addEventListener("click", () => Study.checkAnswer());
      nextBtn.addEventListener("click", () => Study.next());
      exitStudyBtn.addEventListener("click", () => {
        studyMode.style.display = "none";
      });
      showTranslationBtn.addEventListener("click", () => {
        studyTranslationEl.style.display = "block";
      });
      speakBtn.addEventListener("click", () => {
        const w = Study.current();
        if (Study.mode === "sentences" && w.examples && w.examples.length > 0) {
          const ex = w.examples[Math.floor(Math.random() * w.examples.length)];
          speak(ex.de);
        } else {
          speak(w.word);
        }
      });
    </script>
  </body>
</html>
